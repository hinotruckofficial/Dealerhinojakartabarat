###############################################
# üåê FRONTEND SECURITY + SEO + PERFORMANCE
# Official Hino
###############################################

Options -Indexes
RewriteEngine On


###############################################
# 1) FORCE HTTPS (kecuali localhost)
###############################################
RewriteCond %{HTTP_HOST} !^localhost [NC]
RewriteCond %{HTTPS} !=on
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]


###############################################
# 2) ALLOW SEO FILES & FAVICON
###############################################
RewriteRule (^|/)favicon\.(ico|png|gif|jpg|jpeg|webp|svg)$ - [L,NC]
RewriteRule ^(manifest\.json|site\.webmanifest)$ - [L,NC]
RewriteRule ^robots\.txt$ - [L,NC]
RewriteRule ^sitemap.*\.xml$ - [L,NC]


###############################################
# 3) ANTI HOTLINK (IMAGE PROTECTION)
###############################################
RewriteCond %{REQUEST_FILENAME} -f
RewriteCond %{REQUEST_URI} \.(jpe?g|png|gif|svg|webp)$ [NC]
RewriteCond %{HTTP_REFERER} !^$
RewriteCond %{HTTP_REFERER} !^https?://(www\.)?dealerhinojakartabarat\.com [NC]
RewriteRule \.(jpe?g|png|gif|svg|webp)$ - [F,NC,L]


###############################################
# 4) BLOCK SENSITIVE FILES
###############################################
<FilesMatch "(^\.|composer\.json|composer\.lock|package\.json|yarn\.lock|\.env|\.git|\.htpasswd)$">
    Require all denied
</FilesMatch>


###############################################
# 5) BLOCK BAD QUERY / INJECTION
###############################################
RewriteCond %{QUERY_STRING} (\.\./|/etc/passwd|base64|eval\(|system\(|UNION.*SELECT|GLOBALS|_REQUEST) [NC]
RewriteRule .* - [F,L]


###############################################
# 6) BLOCK BOT / SPAM / TOOLS
###############################################
SetEnvIfNoCase Referer "semalt" bad_ref
SetEnvIfNoCase Referer "darodar" bad_ref
SetEnvIfNoCase User-Agent "nikto" bad_bot
SetEnvIfNoCase User-Agent "sqlmap" bad_bot


###############################################
# 7) BLOCK SUSPICIOUS IP
###############################################
<RequireAll>
    Require all granted
    Require not ip 45.146.165.0/24
    Require not ip 185.220.100.0/22
    Require not ip 91.240.118.0/23
    Require not env bad_ref
    Require not env bad_bot
</RequireAll>


###############################################
# 8) SECURITY HEADERS (FIXED + FEATHER ICONS SAFE)
###############################################
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    Header unset X-Powered-By

    Header always set Content-Security-Policy "
        default-src 'self';
        img-src 'self' data: https:;
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com https://ajax.googleapis.com;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com;
        font-src 'self' https://fonts.gstatic.com data:;
        connect-src 'self';
        frame-src 'self';
        media-src 'self';
        worker-src 'self';
        base-uri 'self';
    "
</IfModule>



###############################################
# 9) CACHE PERFORMANCE
###############################################
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType images/webp "access plus 1 year"
    ExpiresByType images/jpeg "access plus 1 year"
    ExpiresByType images/png "access plus 1 year"
    ExpiresByType images/gif "access plus 1 year"
    ExpiresByType images/svg+xml "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresDefault "access plus 3 days"
</IfModule>

<FilesMatch "\.(php|html)$">
    Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
</FilesMatch>


###############################################
# 10) CLEAN URL (SEO FRIENDLY)
###############################################

# Hapus .php dari URL
RewriteCond %{THE_REQUEST} \s/([^\s]+)\.php[\s?] [NC]
RewriteCond %{REQUEST_URI} !^/admin
RewriteRule ^ %1 [R=301,L]

# Jalankan file php tanpa ditulis .php
RewriteCond %{REQUEST_URI} !^/admin
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}\.php -f
RewriteRule ^([^/]+)/?$ $1.php [L,QSA]

# Sitemap manual
RewriteRule ^sitemap-artikel\.xml$ sitemap-artikel.php [L]

###############################################
# üîµ SEO FRIENDLY ARTICLE URL
###############################################

RewriteRule ^artikel/([a-zA-Z0-9-]+)/?$ detail_artikel.php?slug=$1 [L,QSA]

# Redirect artikel/ ke artikel (biar canonical tidak redirect)
RewriteCond %{REQUEST_URI} ^/artikel/$
RewriteRule ^artikel/$ /artikel [L,R=301]


###############################################
# END
###############################################
